<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Visitors Parking Entry</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
</head>

<body class="bg-light">

<div class="container mt-4 mb-5">

    <!-- ADD ENTRY -->
    <div class="card shadow-sm mb-4">
        <div class="card-header text-center fw-bold">üöó Visitors Parking Entry</div>
        <div class="card-body">
            <form id="parkingForm">
                <div class="mb-2">
                    <label class="form-label">Vehicle Number *</label>
                    <input type="text" class="form-control" id="vehicleNumber" required>
                </div>

                <div class="mb-2">
                    <label class="form-label">Visitor Name</label>
                    <input type="text" class="form-control" id="visitorName">
                </div>

                <div class="mb-2">
                    <label class="form-label">Mobile Number</label>
                    <input type="tel" class="form-control" id="mobileNumber">
                </div>

                <div class="mb-2">
                    <label class="form-label">From Where</label>
                    <input type="text" class="form-control" id="fromWhere">
                </div>

                <div class="mb-2">
                    <label class="form-label">Whom To Meet</label>
                    <input type="text" class="form-control" id="whomToMeet">
                </div>

                <div class="mb-2">
                    <label class="form-label">Security Name *</label>
                    <input type="text" class="form-control" id="createdBy" required>
                </div>

                <div class="mb-3">
                    <label class="form-label">Remark</label>
                    <textarea class="form-control" id="remark"></textarea>
                </div>

                <button type="submit" class="btn btn-primary w-100">‚ûï Add Entry</button>
            </form>

            <div id="msg" class="mt-2 text-center"></div>
        </div>
    </div>

    <!-- MARK OUT -->
    <div class="card border-danger mb-4">
        <div class="card-header text-center fw-bold text-danger">üö™ Mark OUT</div>
        <div class="card-body">
            <form id="outForm">
                <div class="mb-2">
                    <label class="form-label">Entry ID *</label>
                    <input type="number" class="form-control" id="outId" required>
                </div>

                <div class="mb-3">
                    <label class="form-label">Security Name *</label>
                    <input type="text" class="form-control" id="outSecurity" required>
                </div>

                <button type="submit" class="btn btn-danger w-100">üö™ Mark OUT</button>
            </form>

            <div id="outMsg" class="mt-2 text-center"></div>
        </div>
    </div>
	
	<!-- INSIDE TOGGLE + COUNT -->
	<div class="card mb-3">
	    <div class="card-body d-flex justify-content-between align-items-center">
	        <button class="btn btn-outline-primary" id="insideBtn"
	                onclick="toggleInside()">
	            üöó Show Only Currently INSIDE
	        </button>

	        <span class="badge bg-success fs-6" id="insideCount">
	            INSIDE: 0
	        </span>
	    </div>
		<div class="text-end text-muted small mb-2" id="lastUpdated">
		    Last updated at : --
		</div>

	</div>


    <!-- SEARCH -->
    <div class="card mb-3">
        <div class="card-body">
            <label class="form-label fw-bold">üîé Search Vehicle Number</label>
            <input type="text" class="form-control mb-2" id="searchVehicle"
                   placeholder="Enter vehicle number">
            <button class="btn btn-dark w-100" onclick="searchVehicle()">Search</button>
        </div>
    </div>

    <!-- HISTORY FILTER -->
    <div class="card mb-3">
        <div class="card-body">
            <label class="form-label fw-bold">üìÖ Select Date</label>
            <input type="date" class="form-control mb-2" id="filterDate">
            <button class="btn btn-secondary w-100" onclick="loadByDate()">üîç View History</button>
        </div>
    </div>

    <!-- TABLE -->
    <div class="card">
        <div class="card-header text-center fw-bold">üìã Entries</div>
        <div class="card-body p-2">
            <div class="table-responsive">
                <table class="table table-sm table-bordered align-middle">
                    <thead class="table-light">
                        <tr>
                            <th>ID</th>
                            <th>Vehicle</th>
                            <th>Name</th>
                            <th>Mobile</th>
                            <th>IN Date</th>
                            <th>IN Time</th>
                            <th>OUT Time</th>
                            <th>Days Parked</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="todayTable">
                        <tr>
                            <td colspan="9" class="text-center">Loading...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

</div>

<!-- ================= JAVASCRIPT ================= -->




<script>
	
	let showOnlyInside = false;
	let lastLoadedData = [];
	
	function updateLastUpdated() {
	    const now = new Date();
	    const time = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
	    document.getElementById("lastUpdated").innerText =
	        `Last updated at : ${time}`;
	}


	
document.getElementById("parkingForm").addEventListener("submit", e => {
    e.preventDefault();

    fetch("/api/parking/add", {
        method: "POST",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({
            vehicleNumber: vehicleNumber.value,
            visitorName: visitorName.value,
            mobileNumber: mobileNumber.value,
            fromWhere: fromWhere.value,
            whomToMeet: whomToMeet.value,
            createdBy: createdBy.value,
            remark: remark.value
        })
    })
    .then(() => {
        msg.innerHTML = "<span class='text-success fw-bold'>Entry Added</span>";
        parkingForm.reset();
        loadTodayEntries();
		updateLastUpdated();
    });
});

document.getElementById("outForm").addEventListener("submit", e => {
    e.preventDefault();

    fetch(`/api/parking/out/${outId.value}?securityName=${outSecurity.value}`, {
        method: "PUT"
    })
    .then(r => r.text())
    .then(t => {
        outMsg.innerHTML = `<b>${t}</b>`;
        outForm.reset();
        loadTodayEntries();
		updateLastUpdated();
    });
});

function renderTable(data) {
	
	updateLastUpdated();

	
	lastLoadedData = data; // keep copy for toggle
	
	
	// calculate INSIDE count (always from full data)
	const insideTotal = data.filter(e => e.outTime === null).length;
	document.getElementById("insideCount").innerText =
	    `INSIDE: ${insideTotal}`;


	    if (showOnlyInside) {
	        data = data.filter(e => e.outTime === null);
	    }

	    todayTable.innerHTML = "";

	    if (data.length === 0) {
	        todayTable.innerHTML =
	            "<tr><td colspan='9' class='text-center'>No INSIDE vehicles</td></tr>";
	        return;
	    }

	
	
	
	// ------------------>
	
	
    todayTable.innerHTML = "";

    if (data.length === 0) {
        todayTable.innerHTML =
            "<tr><td colspan='9' class='text-center'>No records</td></tr>";
        return;
    }

    const today = new Date();
    today.setHours(0,0,0,0);

    data.forEach(e => {
        const inDate = new Date(e.entryDate);
        inDate.setHours(0,0,0,0);

        const daysParked = Math.floor(
            (today - inDate) / (1000 * 60 * 60 * 24)
        );

        let rowClass = "";
        let statusText = "IN";
        let statusColor = "text-danger";

        if (e.outTime) {
            statusText = "OUT";
            statusColor = "text-success";
        } else if (daysParked >= 1) {
            rowClass = "table-danger";
        }

        const mobile = e.mobileNumber
            ? `<a href="tel:${e.mobileNumber}" class="fw-bold">${e.mobileNumber}</a>`
            : "-";

        todayTable.innerHTML += `
        <tr class="${rowClass}">
            <td>${e.id}</td>
            <td>${e.vehicleNumber}</td>
            <td>${e.visitorName ?? ""}</td>
            <td>${mobile}</td>
            <td>${e.entryDate}</td>
            <td>${new Date(e.inTime).toLocaleTimeString()}</td>
            <td>${e.outTime ? new Date(e.outTime).toLocaleTimeString() : "-"}</td>
            <td class="fw-bold">${daysParked} day(s)</td>
            <td class="${statusColor} fw-bold">${statusText}</td>
        </tr>`;
    });
}

function loadTodayEntries() {
    fetch("/api/parking/today")
        .then(r => r.json())
        .then(renderTable);
}

function loadByDate() {
    if (!filterDate.value) return alert("Select date");
    fetch(`/api/parking/by-date?date=${filterDate.value}`)
        .then(r => r.json())
        .then(renderTable);
}

function searchVehicle() {
    const v = document.getElementById("searchVehicle").value.trim();
    if (!v) return alert("Enter vehicle number");

    fetch(`/api/parking/search?vehicle=${v}`)
        .then(r => r.json())
        .then(renderTable);
}

loadTodayEntries();


//==============

function toggleInside() {
    showOnlyInside = !showOnlyInside;

    const btn = document.getElementById("insideBtn");

    if (showOnlyInside) {
        btn.innerText = "üìã Show ALL Entries";
        btn.classList.remove("btn-outline-primary");
        btn.classList.add("btn-outline-danger");
    } else {
        btn.innerText = "üöó Show Only Currently INSIDE";
        btn.classList.remove("btn-outline-danger");
        btn.classList.add("btn-outline-primary");
    }

    renderTable(lastLoadedData);
}


// üîÑ AUTO REFRESH every 30 seconds (30,000 ms)
setInterval(() => {
    // refresh only when NOT searching or filtering
    if (
        document.getElementById("searchVehicle").value === "" &&
        document.getElementById("filterDate").value === ""
    ) {
        loadTodayEntries();
    }
}, 30000);


</script>

</body>
</html>
